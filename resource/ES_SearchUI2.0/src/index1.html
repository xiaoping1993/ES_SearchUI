<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8"> 
<title>ES SearchUI</title> 
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" media="screen" />
<script src="jquery-3.3.1.js"></script>
<script src="layer.js"></script>
<link rel="stylesheet" href="layui/css/layui.css" media="all">
<link rel="stylesheet" href="theme/default/drawer.css" media="all">
<script src="layui/layui.js" type="text/javascript"></script>
</head>
<body>
	<div id="drawer" style="height: 100%;">
    <div id="customFuntion" style="display:none;">
      <div class="drawer-header">
        <div class="drawer-header-title">定制化功能</div>
      </div>
      <div class="drawer-header-content">
        <p id="export" class="pBox">
          <a>
            Export
          </a>
        </p>
        <p id="download" class="pBox">
          <a>
            DownLoad
          </a>
        </p>
      </div>
    </div>
    <div style="height: 100%;">
      <i class="layui-icon layui-icon-shrink-right" id='tig'></i>
      <iframe id="discover" width="100%" height="100%" scrolling="yes" frameborder="0"
        src="http://47.103.64.41:5601/app/discover"></iframe>
    </div>
  </div>
</body>
</html>
<script>
  layui.config({
    base: './'
  }).extend({
    drawer: 'layDrawer'
  });
  layui.use(['drawer'], function () {
    var drawer = layui.drawer;
    drawer.render({
      //trigger和elem只能为id
      trigger: '#tig',
      elem: '#customFuntion'
        //top   bottom   left   right 默认为left
        ,
      position: 'left'
        //默认为230  可以填百分比
        ,
      specs: '25%',
      open: function () {
        // layer.msg("打开")
      },
      close: function () {
        // layer.msg("关闭")
      }
    });
  });
</script>
<script>
  var result1 = '';
  var size = 500;
  $(document).ready(function () {
    window.addEventListener('message', function (e) {
      if (e.data.type === 'queryResult') {
        const resultArray = [];
        resultArray.push(e.data.queryParam == "" ? ' ' : e.data.queryParam);
        console.log(e.data.queryParam)
        var result = JSON.parse(e.data.content);
        //export数据解析
        $.each(result.hits.hits, (index, value) => {
          const _id = value._id ? value._id : '';
          resultArray.push(_id);
        });
        result1 = resultArray.join(',');
      } else if (e.data.type === 'queryParam') {
        var queryParam = JSON.parse(e.data.content);
        console.log(queryParam, 'queryParam----')
        size = queryParam.params.body.size;
      }
    })
    $('#customFuntion').on('click', "#export", function () {
      console.log('点击export')
      layer.msg('正在导出查询结果前' + size + '条数据，请稍后');
      parent.postMessage(result1, '*');
    })
    $('#customFuntion').on('click', "#download", function () {
      console.log('点击download')
      layer.msg('功能开发中...');
      console.log($("#discover").contents(),'$("#discover").contents()')
    })
    // $(window.frames["discover"].document).find($('.loginWelcome__logo')).attr("checked","true");
    // console.log($(window.frames["discover"].document).find(".loginWelcome__logo").html(),'html---')
  
    //  解决跨域 
   //  let data = {"params":{"ignoreThrottled":true,"index":"pki_dzbl_demo1","body":{"version":true,"size":500,"sort":[{"createtime":{"order":"desc","unmapped_type":"boolean"}}],"aggs":{"2":{"date_histogram":{"field":"createtime","fixed_interval":"30d","time_zone":"Asia/Shanghai","min_doc_count":1}}},"stored_fields":["*"],"script_fields":{},"docvalue_fields":[{"field":"createtime","format":"date_time"}],"_source":{"excludes":[]},"query":{"bool":{"must":[],"filter":[{"match_all":{}},{"range":{"createtime":{"gte":"2018-03-31T07:02:06.123Z","lte":"2021-03-31T07:02:06.123Z","format":"strict_date_optional_time"}}}],"should":[],"must_not":[]}},"highlight":{"pre_tags":["@kibana-highlighted-field@"],"post_tags":["@/kibana-highlighted-field@"],"fields":{"*":{}},"fragment_size":2147483647}},"rest_total_hits_as_int":true,"ignore_unavailable":true,"ignore_throttled":true,"preference":1617172685231,"timeout":"30000ms"}}
   //  $.ajax(
   //    {
   //        url: "/api/internal/search/es",
   //        type: "POST",
   //        dataType: "json",
   //        data: JSON.stringify(data),
   //        headers:{
   //          "kbn-version":'7.9.3',
   //          'Content-Type':'application/json;charset=utf8',
   //        },
   //        // xhrFields:{
   //        //   withCredentials:true
   //        // },//支持跨域发送cookies
   //        success: function (result) {
   //            console.log(result,'刷新第二次在82里面 可以获取到数据result----');
			//   layer.msg("当登陆有cookie,可以获取到数据result----")
   //        },
   //        error: function (xhr, status, p3, p4) {
   //          console.log(xhr,status,'status')
			// if(xhr.status == 401) {
			// 	layer.msg("第一遍由于没有登录 所以cookie 为空 所以请求为401")
			// }
   //        }
   //    });
   
  });
</script>